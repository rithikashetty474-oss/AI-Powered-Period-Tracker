{% extends "base.html" %}

{% block title %}Wellness Streaks - Cycliqe{% endblock %}

{% block content %}
<div class="streaks-container">
    <!-- Self-Care Streak Section -->
    <div class="selfcare-section">
        <h1 class="selfcare-heading">Self-Care Streak</h1>
        
        <div class="selfcare-container">
            <!-- Circular Progress Ring -->
            <div class="progress-ring-container">
                <svg class="progress-ring" width="200" height="200">
                    <circle
                        class="progress-ring-circle-bg"
                        stroke="#E0E0E0"
                        stroke-width="12"
                        fill="transparent"
                        r="85"
                        cx="100"
                        cy="100"
                    />
                    <circle
                        class="progress-ring-circle"
                        id="progressCircle"
                        stroke="#FF6B9D"
                        stroke-width="12"
                        fill="transparent"
                        r="85"
                        cx="100"
                        cy="100"
                        transform="rotate(-90 100 100)"
                        stroke-dasharray="534"
                        stroke-dashoffset="534"
                    />
                </svg>
                <div class="progress-ring-content">
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                    <div class="progress-label">Complete</div>
                </div>
            </div>
            
            <!-- Streak Counter -->
            <div class="selfcare-streak-display">
                <span class="streak-icon">ðŸ”¥</span>
                <span class="streak-text">Current Streak: <strong id="selfcareStreak">0</strong> Days</span>
            </div>
            
            <!-- Self-Care Tasks -->
            <div class="selfcare-tasks">
                <div class="selfcare-task-item">
                    <label class="selfcare-checkbox-label">
                        <input type="checkbox" id="task-meditation" class="selfcare-checkbox">
                        <span class="selfcare-checkbox-custom"></span>
                        <span class="selfcare-task-text">
                            <i class="fas fa-spa"></i>
                            Meditation
                        </span>
                    </label>
                </div>
                
                <div class="selfcare-task-item">
                    <label class="selfcare-checkbox-label">
                        <input type="checkbox" id="task-walk" class="selfcare-checkbox">
                        <span class="selfcare-checkbox-custom"></span>
                        <span class="selfcare-task-text">
                            <i class="fas fa-walking"></i>
                            Walk
                        </span>
                    </label>
                </div>
                
                <div class="selfcare-task-item">
                    <label class="selfcare-checkbox-label">
                        <input type="checkbox" id="task-water" class="selfcare-checkbox">
                        <span class="selfcare-checkbox-custom"></span>
                        <span class="selfcare-task-text">
                            <i class="fas fa-tint"></i>
                            Drinking enough water
                        </span>
                    </label>
                </div>
                
                <div class="selfcare-task-item">
                    <label class="selfcare-checkbox-label">
                        <input type="checkbox" id="task-sleep" class="selfcare-checkbox">
                        <span class="selfcare-checkbox-custom"></span>
                        <span class="selfcare-task-text">
                            <i class="fas fa-bed"></i>
                            Sleeping 7+ hours
                        </span>
                    </label>
                </div>
                
                <div class="selfcare-task-item">
                    <label class="selfcare-checkbox-label">
                        <input type="checkbox" id="task-supplements" class="selfcare-checkbox">
                        <span class="selfcare-checkbox-custom"></span>
                        <span class="selfcare-task-text">
                            <i class="fas fa-pills"></i>
                            Taking supplements
                        </span>
                    </label>
                </div>
            </div>
            
            <!-- Save Button -->
            <button id="saveSelfcareBtn" class="btn-primary btn-selfcare">
                <i class="fas fa-save"></i>
                Save Today's Self-Care
            </button>
        </div>
    </div>
    
    <!-- Success Popup -->
    <div id="successPopup" class="success-popup">
        <div class="success-popup-content">
            <div class="success-icon">âœ¨</div>
            <h3>Day Complete!</h3>
            <p>Great job completing all your self-care tasks!</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Self-Care Section
    let selfcareTasks = {
        meditation: false,
        walk: false,
        water: false,
        sleep: false,
        supplements: false
    };
    
    // Load today's self-care data
    async function loadSelfcareData() {
        try {
            const response = await fetch('/api/get-selfcare');
            const data = await response.json();
            
            if (data.success) {
                selfcareTasks = data.tasks;
                
                // Update checkboxes
                document.getElementById('task-meditation').checked = data.tasks.meditation;
                document.getElementById('task-walk').checked = data.tasks.walk;
                document.getElementById('task-water').checked = data.tasks.water;
                document.getElementById('task-sleep').checked = data.tasks.sleep;
                document.getElementById('task-supplements').checked = data.tasks.supplements;
                
                // Update progress ring
                updateProgressRing(data.percentage);
                
                // Update streak
                document.getElementById('selfcareStreak').textContent = data.streak || 0;
            }
        } catch (error) {
            console.error('Error loading self-care data:', error);
        }
    }
    
    // Update progress ring
    function updateProgressRing(percentage) {
        const circle = document.getElementById('progressCircle');
        const percentageText = document.getElementById('progressPercentage');
        
        const radius = 85;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (percentage / 100) * circumference;
        
        // Initialize stroke-dasharray on first call
        if (!circle.getAttribute('stroke-dasharray')) {
            circle.setAttribute('stroke-dasharray', circumference);
            circle.style.strokeDashoffset = circumference;
        }
        
        // Animate to new offset
        circle.style.strokeDashoffset = offset;
        percentageText.textContent = Math.round(percentage) + '%';
        
        // Change color based on percentage
        if (percentage === 100) {
            circle.style.stroke = '#4CAF50';
            percentageText.style.color = '#4CAF50';
        } else if (percentage >= 60) {
            circle.style.stroke = '#FF9800';
            percentageText.style.color = '#FF9800';
        } else {
            circle.style.stroke = '#FF6B9D';
            percentageText.style.color = '#FF6B9D';
        }
    }
    
    // Calculate current progress
    function calculateProgress() {
        const completed = Object.values(selfcareTasks).filter(v => v).length;
        const percentage = (completed / 5) * 100;
        updateProgressRing(percentage);
        return percentage;
    }
    
    // Handle checkbox changes
    document.querySelectorAll('.selfcare-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const taskId = this.id.replace('task-', '');
            selfcareTasks[taskId] = this.checked;
            const percentage = calculateProgress();
            
            // If 100%, show success popup
            if (percentage === 100) {
                showSuccessPopup();
            }
        });
    });
    
    // Save self-care data
    document.getElementById('saveSelfcareBtn').addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        try {
            const response = await fetch('/api/save-selfcare', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    ...selfcareTasks,
                    date: new Date().toISOString().split('T')[0]
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update streak
                const streakResponse = await fetch('/api/get-selfcare');
                const streakData = await streakResponse.json();
                if (streakData.success) {
                    document.getElementById('selfcareStreak').textContent = streakData.streak || 0;
                }
                
                // Show success message
                if (data.percentage === 100) {
                    showSuccessPopup();
                } else {
                    showToast('Self-care saved successfully!');
                }
            } else {
                showToast('Error saving self-care: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error saving self-care:', error);
            showToast('Error saving self-care. Please try again.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
    
    // Show success popup
    function showSuccessPopup() {
        const popup = document.getElementById('successPopup');
        popup.classList.add('show');
        
        // Trigger confetti
        triggerConfetti();
        
        // Hide after 3 seconds
        setTimeout(() => {
            popup.classList.remove('show');
        }, 3000);
    }
    
    // Simple confetti effect
    function triggerConfetti() {
        const colors = ['#FF6B9D', '#9B59B6', '#4CAF50', '#FF9800', '#2196F3'];
        const confettiCount = 50;
        
        for (let i = 0; i < confettiCount; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.width = (Math.random() * 10 + 5) + 'px';
                confetti.style.height = (Math.random() * 10 + 5) + 'px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 4000);
            }, i * 20);
        }
    }
    
    // Show toast message
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // Load self-care data on page load
    loadSelfcareData();
</script>
{% endblock %}

