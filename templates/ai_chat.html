{% extends "base.html" %}

{% block title %}AI Chat - Cycliqe{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <div class="chat-header-content">
            <div class="chat-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div>
                <h1>AI Wellness Assistant</h1>
                <p class="chat-status">
                    <span class="status-dot"></span>
                    Online
                </p>
            </div>
        </div>
    </div>

    <div class="chat-messages" id="chatMessages">
        <div class="message ai-message">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <p>Hello! I'm your AI wellness assistant. I can help you with questions about your cycle, mood patterns, health tips, and more. How can I assist you today?</p>
            </div>
        </div>
    </div>

    <div class="chat-input-container">
        <div class="quick-questions">
            <button class="quick-question-btn" onclick="sendQuickQuestion('What can you help me with?')">
                What can you help me with?
            </button>
            <button class="quick-question-btn" onclick="sendQuickQuestion('Tell me about my cycle patterns')">
                Tell me about my cycle patterns
            </button>
            <button class="quick-question-btn" onclick="sendQuickQuestion('How can I manage period pain?')">
                How can I manage period pain?
            </button>
        </div>
        <form id="chatForm" class="chat-input-form">
            <input 
                type="text" 
                id="chatInput" 
                placeholder="Type your message..." 
                autocomplete="off"
                required
            >
            <button type="submit" class="chat-send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('chatForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message
        addMessage(message, 'user');
        input.value = '';
        
        // Show typing indicator
        const typingId = showTypingIndicator();
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: message})
            });
            
            const data = await response.json();
            
            // Remove typing indicator
            removeTypingIndicator(typingId);
            
            if (data.success) {
                addMessage(data.reply, 'ai');
            } else {
                addMessage('Sorry, I encountered an error. Please try again.', 'ai');
            }
        } catch (error) {
            removeTypingIndicator(typingId);
            addMessage('Sorry, I\'m having trouble connecting. Please try again later.', 'ai');
        }
    });

    function addMessage(text, sender) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        if (sender === 'user') {
            messageDiv.innerHTML = `
                <div class="message-content">
                    <p>${escapeHtml(text)}</p>
                </div>
                <div class="message-avatar user-avatar">
                    <i class="fas fa-user"></i>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <p>${escapeHtml(text)}</p>
                </div>
            `;
        }
        
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    function showTypingIndicator() {
        const messagesContainer = document.getElementById('chatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai-message typing-indicator';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        messagesContainer.appendChild(typingDiv);
        scrollToBottom();
        return 'typing-indicator';
    }

    function removeTypingIndicator(id) {
        const indicator = document.getElementById(id);
        if (indicator) {
            indicator.remove();
        }
    }

    function sendQuickQuestion(question) {
        document.getElementById('chatInput').value = question;
        document.getElementById('chatForm').dispatchEvent(new Event('submit'));
    }

    function scrollToBottom() {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Focus input on load
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('chatInput').focus();
    });
</script>
{% endblock %}

